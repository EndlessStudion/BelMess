<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üì± Telegram –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</title>
    <style>
        :root {
            --primary: #0084ff;
            --secondary: #f0f2f5;
            --dark: #050505;
            --light: #ffffff;
            --gray: #8a8d91;
            --online: #31a24c;
            --unread: #0084ff;
            --menu-bg: #182533;
            --menu-item-hover: #2b5278;
            --message-sent: #0084ff;
            --message-received: #ffffff;
            --shadow: rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--primary);
            height: 100vh;
            overflow: hidden;
            color: var(--dark);
        }
        
        /* –ì–ª–∞–≤–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
        .app-container {
            width: 100%;
            height: 100vh;
            background: white;
            position: relative;
            overflow: hidden;
            display: flex;
        }
        
        /* –õ–µ–≤–æ–µ –º–µ–Ω—é */
        .sidebar {
            width: 280px;
            background: var(--menu-bg);
            color: white;
            display: flex;
            flex-direction: column;
            height: 100%;
            border-right: 1px solid #243142;
            position: relative;
            z-index: 100;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                transform: translateX(-100%);
                width: 85%;
                max-width: 300px;
                transition: transform 0.3s ease;
            }
            
            .sidebar.show {
                transform: translateX(0);
                box-shadow: 10px 0 30px rgba(0,0,0,0.3);
            }
        }
        
        /* –®–∞–ø–∫–∞ –º–µ–Ω—é */
        .sidebar-header {
            padding: 20px 15px;
            border-bottom: 1px solid #243142;
        }
        
        .sidebar-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            display: none;
            padding: 5px;
            border-radius: 50%;
        }
        
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }
        }
        
        .sidebar-search {
            background: #2b3b4e;
            border-radius: 8px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
        }
        
        .sidebar-search input {
            background: none;
            border: none;
            color: white;
            flex: 1;
            padding: 5px;
            outline: none;
            font-size: 14px;
        }
        
        .sidebar-search input::placeholder {
            color: #8a98a8;
        }
        
        /* –°–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤ –≤ –º–µ–Ω—é */
        .sidebar-chats {
            flex: 1;
            overflow-y: auto;
            padding: 10px 0;
        }
        
        .menu-chat-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            transition: background 0.2s;
            border-left: 3px solid transparent;
        }
        
        .menu-chat-item:hover {
            background: var(--menu-item-hover);
        }
        
        .menu-chat-item.active {
            background: var(--menu-item-hover);
            border-left-color: var(--primary);
        }
        
        .menu-chat-avatar {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            margin-right: 12px;
            flex-shrink: 0;
            cursor: pointer;
        }
        
        .menu-chat-info {
            flex: 1;
            min-width: 0;
        }
        
        .menu-chat-name {
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 15px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            cursor: pointer;
        }
        
        .menu-chat-last {
            font-size: 13px;
            color: #8a98a8;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .menu-chat-time {
            font-size: 11px;
            color: #8a98a8;
            margin-top: 2px;
        }
        
        .unread-badge {
            background: var(--primary);
            color: white;
            font-size: 11px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        
        /* –ù–∏–∂–Ω—è—è —á–∞—Å—Ç—å –º–µ–Ω—é */
        .sidebar-footer {
            padding: 15px;
            border-top: 1px solid #243142;
        }
        
        .menu-item {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            cursor: pointer;
            border-radius: 8px;
            transition: background 0.2s;
            margin-bottom: 5px;
        }
        
        .menu-item:hover {
            background: var(--menu-item-hover);
        }
        
        .menu-icon {
            margin-right: 12px;
            font-size: 18px;
            width: 24px;
            text-align: center;
        }
        
        .menu-text {
            font-size: 15px;
            font-weight: 500;
        }
        
        /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        
        /* –®–∞–ø–∫–∞ —á–∞—Ç–∞ */
        .chat-header {
            height: 60px;
            background: white;
            border-bottom: 1px solid #e4e6eb;
            display: flex;
            align-items: center;
            padding: 0 15px;
            justify-content: space-between;
        }
        
        .chat-header-left {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .chat-header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-back-button {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 24px;
            margin-right: 15px;
            cursor: pointer;
            display: none;
        }
        
        @media (max-width: 768px) {
            .chat-back-button {
                display: block;
            }
        }
        
        .chat-info {
            display: flex;
            align-items: center;
            flex: 1;
        }
        
        .chat-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 16px;
            margin-right: 12px;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .chat-avatar.viewable:hover::after {
            content: 'üëÅÔ∏è';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            color: white;
        }
        
        .chat-title {
            flex: 1;
        }
        
        .chat-title h2 {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 3px;
            cursor: pointer;
            display: inline-block;
            padding: 2px 5px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .chat-title h2:hover {
            background: rgba(0,0,0,0.05);
        }
        
        .chat-status {
            font-size: 13px;
            color: var(--gray);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .online-dot {
            width: 8px;
            height: 8px;
            background: var(--online);
            border-radius: 50%;
        }
        
        /* –ò–∫–æ–Ω–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –≤ —á–∞—Ç–µ */
        .chat-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .chat-action-button {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .chat-action-button:hover {
            background-color: rgba(0, 132, 255, 0.1);
        }
        
        .chat-leave-button {
            background: none;
            border: none;
            color: #ff4444;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
        }
        
        .chat-leave-button:hover {
            background-color: rgba(255, 68, 68, 0.1);
        }
        
        /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π */
        .messages-container {
            flex: 1;
            padding: 20px 15px 80px;
            overflow-y: auto;
            background: var(--secondary);
        }
        
        /* –°–æ–æ–±—â–µ–Ω–∏—è */
        .message {
            margin-bottom: 15px;
            max-width: 75%;
        }
        
        .message.received {
            margin-right: auto;
        }
        
        .message.sent {
            margin-left: auto;
        }
        
        .message-bubble {
            padding: 12px 15px;
            border-radius: 18px;
            position: relative;
            line-height: 1.4;
            word-wrap: break-word;
            font-size: 15px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        
        .received .message-bubble {
            background: white;
            border-bottom-left-radius: 5px;
        }
        
        .sent .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 5px;
        }
        
        .message-time {
            color: var(--gray);
            font-size: 11px;
            margin-top: 5px;
            text-align: right;
        }
        
        /* –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ */
        .input-container {
            background: white;
            padding: 10px 15px;
            border-top: 1px solid #e4e6eb;
            position: fixed;
            bottom: 0;
            left: 280px;
            right: 0;
            display: none;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .input-container {
                left: 0;
            }
        }
        
        .input-container.show {
            display: block;
        }
        
        .input-wrapper {
            display: flex;
            gap: 8px;
            align-items: flex-end;
            max-width: 100%;
        }
        
        .message-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e4e6eb;
            border-radius: 20px;
            font-size: 16px;
            resize: none;
            min-height: 45px;
            max-height: 100px;
            font-family: inherit;
            background: var(--secondary);
            outline: none;
            max-width: calc(100% - 50px);
        }
        
        .message-input:focus {
            border-color: var(--primary);
        }
        
        /* –£–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ */
        .send-button {
            width: 40px;
            height: 40px;
            min-width: 40px;
            min-height: 40px;
            border-radius: 50%;
            background: var(--primary);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            flex-shrink: 0;
            margin-bottom: 2px;
            transition: background-color 0.2s;
        }
        
        .send-button:hover {
            background-color: #0073e6;
        }
        
        .send-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }
        
        /* –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ */
        .auth-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 2000;
        }
        
        .auth-screen.hidden {
            display: none;
        }
        
        .auth-logo {
            font-size: 60px;
            margin-bottom: 20px;
        }
        
        .auth-title {
            color: white;
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .auth-subtitle {
            color: rgba(255,255,255,0.9);
            text-align: center;
            margin-bottom: 30px;
            line-height: 1.4;
        }
        
        .auth-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            width: 100%;
            max-width: 300px;
        }
        
        .auth-button {
            padding: 16px;
            background: white;
            color: var(--primary);
            border: none;
            border-radius: 15px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* –§–æ—Ä–º—ã */
        .form-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 20px;
            z-index: 2500;
        }
        
        .form-screen.hidden {
            display: none;
        }
        
        .form-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 100%;
            max-width: 350px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.2);
        }
        
        .form-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 25px;
            color: var(--dark);
            text-align: center;
        }
        
        .form-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e4e6eb;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
        }
        
        .form-input:focus {
            border-color: var(--primary);
        }
        
        .form-error {
            color: #ff6b6b;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-button {
            flex: 1;
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .form-button.primary {
            background: var(--primary);
            color: white;
        }
        
        .form-button.secondary {
            background: #e4e6eb;
            color: var(--dark);
        }
        
        /* –î–∏–∞–ª–æ–≥ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ - –£–î–ê–õ–ï–ù */
        
        /* –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è */
        .profile-screen {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            z-index: 3500;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
        }
        
        .profile-screen.show {
            transform: translateX(0);
        }
        
        .profile-header {
            background: linear-gradient(135deg, var(--primary), #0056b3);
            color: white;
            padding: 40px 20px 30px;
            text-align: center;
            position: relative;
        }
        
        .profile-back-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: white;
            color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            margin: 0 auto 20px;
            border: 4px solid white;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        
        .profile-avatar.editable:hover::after {
            content: '‚úèÔ∏è';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .profile-avatar.viewable:hover::after {
            content: 'üëÅÔ∏è';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            color: white;
        }
        
        .profile-name {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
            cursor: pointer;
            display: inline-block;
            padding: 5px 10px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .profile-name:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .profile-username {
            font-size: 16px;
            opacity: 0.9;
            margin-bottom: 5px;
            cursor: pointer;
            display: inline-block;
            padding: 3px 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .profile-username:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .profile-username.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .profile-status {
            font-size: 14px;
            opacity: 0.8;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .profile-content {
            padding: 30px 20px;
        }
        
        .profile-section {
            margin-bottom: 30px;
        }
        
        .profile-section-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .profile-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }
        
        .info-item {
            margin-bottom: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 15px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }
        
        .info-label {
            font-weight: 500;
            color: #6c757d;
        }
        
        .info-value {
            font-weight: 500;
            color: var(--dark);
        }
        
        .editable-field {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .editable-field:hover {
            background: #e9ecef;
        }
        
        .viewable-field {
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .viewable-field:hover {
            background: #e9ecef;
        }
        
        .profile-bio {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-top: 10px;
        }
        
        .profile-bio textarea {
            width: 100%;
            min-height: 100px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            font-size: 16px;
            resize: vertical;
            outline: none;
        }
        
        .char-count {
            text-align: right;
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
        
        .profile-actions {
            padding: 0 20px 30px;
        }
        
        .profile-button {
            width: 100%;
            padding: 16px;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        
        /* –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏ */
        .avatar-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .avatar-dialog.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .avatar-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }
        
        .avatar-options {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 20px 0;
        }
        
        .avatar-option {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.2s;
        }
        
        .avatar-option:hover {
            transform: scale(1.1);
        }
        
        .avatar-option.selected {
            border-color: var(--primary);
        }
        
        .avatar-preview {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            font-weight: bold;
            margin: 0 auto 20px;
        }
        
        /* –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏ */
        .edit-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4500;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .edit-dialog.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .edit-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 400px;
        }
        
        .edit-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .edit-input {
            width: 100%;
            padding: 15px;
            margin-bottom: 15px;
            border: 2px solid #e4e6eb;
            border-radius: 12px;
            font-size: 16px;
            outline: none;
        }
        
        .edit-input:focus {
            border-color: var(--primary);
        }
        
        .edit-error {
            color: #ff6b6b;
            font-size: 14px;
            margin-bottom: 15px;
            display: none;
        }
        
        .edit-time-left {
            color: #666;
            font-size: 14px;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .edit-buttons {
            display: flex;
            gap: 10px;
        }
        
        .edit-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .edit-button.cancel {
            background: #f0f2f5;
            color: var(--dark);
        }
        
        .edit-button.save {
            background: var(--primary);
            color: white;
        }
        
        /* –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —á–∞—Ç–∞ */
        .confirm-chat-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .confirm-chat-dialog.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .confirm-chat-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        .confirm-chat-icon {
            font-size: 50px;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .confirm-chat-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .confirm-chat-text {
            color: var(--gray);
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .confirm-chat-buttons {
            display: flex;
            gap: 10px;
        }
        
        .confirm-chat-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .confirm-chat-button.cancel {
            background: #f0f2f5;
            color: var(--dark);
        }
        
        .confirm-chat-button.leave {
            background: #ff4444;
            color: white;
        }
        
        /* –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ */
        .confirm-dialog {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s;
        }
        
        .confirm-dialog.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .confirm-container {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 350px;
            text-align: center;
        }
        
        .confirm-icon {
            font-size: 50px;
            margin-bottom: 20px;
            color: var(--primary);
        }
        
        .confirm-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--dark);
        }
        
        .confirm-text {
            color: var(--gray);
            margin-bottom: 25px;
            line-height: 1.5;
        }
        
        .confirm-buttons {
            display: flex;
            gap: 10px;
        }
        
        .confirm-button {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
        }
        
        .confirm-button.cancel {
            background: #f0f2f5;
            color: var(--dark);
        }
        
        .confirm-button.logout {
            background: #ff4444;
            color: white;
        }
        
        /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: white;
            padding: 12px 20px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
            z-index: 5000;
            max-width: 90%;
            text-align: center;
        }
        
        /* –ó–∞–≥–ª—É—à–∫–∞ –¥–ª—è –ø—É—Å—Ç–æ–≥–æ —á–∞—Ç–∞ */
        .empty-chat {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            padding: 40px 20px;
            color: #666;
            text-align: center;
        }
        
        .empty-chat-icon {
            font-size: 60px;
            margin-bottom: 20px;
            opacity: 0.5;
        }
        
        .empty-chat-title {
            font-size: 18px;
            margin-bottom: 10px;
            color: #333;
        }
        
        .empty-chat-text {
            font-size: 14px;
            line-height: 1.4;
            opacity: 0.7;
            max-width: 300px;
        }
        
        /* –û–≤–µ—Ä–ª–µ–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            display: none;
        }
        
        .overlay.show {
            display: block;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                box-shadow: 5px 0 20px rgba(0,0,0,0.2);
            }
            
            .chat-actions {
                gap: 10px;
            }
            
            .send-button {
                width: 38px;
                height: 38px;
            }
        }
    </style>
</head>
<body>
    <!-- –≠–∫—Ä–∞–Ω –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-logo">üí¨</div>
        <h1 class="auth-title">Telegram –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</h1>
        <p class="auth-subtitle">–û–±—â–∞–π—Ç–µ—Å—å –≤ –ª–∏—á–Ω—ã—Ö –∏ –≥—Ä—É–ø–ø–æ–≤—ã—Ö —á–∞—Ç–∞—Ö</p>
        
        <div class="auth-buttons">
            <button class="auth-button" id="loginButton">
                –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç
            </button>
            <button class="auth-button" id="registerButton">
                –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
            </button>
        </div>
    </div>
    
    <!-- –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ -->
    <div class="form-screen hidden" id="loginScreen">
        <div class="form-container">
            <div class="form-title">–í—Ö–æ–¥ –≤ –∞–∫–∫–∞—É–Ω—Ç</div>
            <input type="text" class="form-input" id="loginPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ username" required>
            <div class="form-error" id="loginPhoneError"></div>
            
            <input type="password" class="form-input" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" required>
            <div class="form-error" id="loginPasswordError"></div>
            
            <div class="form-buttons">
                <button class="form-button secondary" id="loginBackButton">–ù–∞–∑–∞–¥</button>
                <button class="form-button primary" id="loginSubmitButton">–í–æ–π—Ç–∏</button>
            </div>
        </div>
    </div>
    
    <!-- –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
    <div class="form-screen hidden" id="registerScreen">
        <div class="form-container">
            <div class="form-title">–°–æ–∑–¥–∞–Ω–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞</div>
            <input type="text" class="form-input" id="registerPhone" placeholder="–¢–µ–ª–µ—Ñ–æ–Ω" required>
            <div class="form-error" id="registerPhoneError"></div>
            
            <input type="text" class="form-input" id="registerUsername" placeholder="Username (—É–Ω–∏–∫–∞–ª—å–Ω—ã–π)" required>
            <div class="form-error" id="registerUsernameError"></div>
            
            <input type="password" class="form-input" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω. 6 —Å–∏–º–≤–æ–ª–æ–≤)" required>
            <div class="form-error" id="registerPasswordError"></div>
            
            <input type="text" class="form-input" id="registerDisplayName" placeholder="–í–∞—à–µ –∏–º—è (–∫–∞–∫ –≤–∞—Å –∑–æ–≤—É—Ç)" required>
            <div class="form-error" id="registerDisplayNameError"></div>
            
            <div class="form-buttons">
                <button class="form-button secondary" id="registerBackButton">–ù–∞–∑–∞–¥</button>
                <button class="form-button primary" id="registerSubmitButton">–°–æ–∑–¥–∞—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –û—Å–Ω–æ–≤–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ -->
    <div class="app-container hidden" id="appContainer">
        <!-- –õ–µ–≤–æ–µ –º–µ–Ω—é -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <span>–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</span>
                    <button class="menu-toggle" id="menuToggle">‚úï</button>
                </div>
                <div class="sidebar-search">
                    <input type="text" id="sidebarSearch" placeholder="–ü–æ–∏—Å–∫ –ø–æ username...">
                </div>
            </div>
            
            <div class="sidebar-chats" id="sidebarChats">
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h3 class="empty-chat-title">–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                    <p class="empty-chat-text">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                </div>
            </div>
            
            <div class="sidebar-footer">
                <!-- –£–î–ê–õ–ï–ù–ê –ö–ù–û–ü–ö–ê –ù–û–í–û–ì–û –ß–ê–¢–ê -->
                <div class="menu-item" id="profileMenuItem">
                    <div class="menu-icon">üë§</div>
                    <div class="menu-text">–ü—Ä–æ—Ñ–∏–ª—å</div>
                </div>
                <div class="menu-item" id="logoutMenuItem">
                    <div class="menu-icon">üö™</div>
                    <div class="menu-text">–í—ã–π—Ç–∏</div>
                </div>
            </div>
        </div>
        
        <!-- –û–≤–µ—Ä–ª–µ–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
        <div class="overlay" id="overlay"></div>
        
        <!-- –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç -->
        <div class="main-content" id="mainContent">
            <!-- –®–∞–ø–∫–∞ —á–∞—Ç–∞ -->
            <div class="chat-header">
                <div class="chat-header-left">
                    <button class="chat-menu-button" id="chatMenuButton">‚ò∞</button>
                    <button class="chat-back-button" id="chatBackButton">‚Üê</button>
                    <div class="chat-info">
                        <div class="chat-avatar viewable" id="chatAvatar">üí¨</div>
                        <div class="chat-title">
                            <h2 id="chatTitle">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h2>
                            <div class="chat-status">
                                <span class="online-dot"></span>
                                <span id="chatStatus">–≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="chat-header-right" id="chatHeaderRight">
                    <!-- –ò–∫–æ–Ω–∫–∏ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —á–∞—Ç–∞ -->
                </div>
            </div>
            
            <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏–π -->
            <div class="messages-container" id="messagesContainer">
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h3 class="empty-chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p class="empty-chat-text">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                </div>
            </div>
            
            <!-- –ü–∞–Ω–µ–ª—å –≤–≤–æ–¥–∞ -->
            <div class="input-container" id="inputContainer">
                <div class="input-wrapper">
                    <textarea 
                        class="message-input" 
                        id="messageInput"
                        placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                        rows="1"
                        maxlength="1000"
                    ></textarea>
                    <button class="send-button" id="sendButton">
                        <svg viewBox="0 0 24 24" fill="white" width="20" height="20">
                            <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –Ω–æ–≤–æ–≥–æ —á–∞—Ç–∞ - –£–î–ê–õ–ï–ù -->
    
    <!-- –≠–∫—Ä–∞–Ω –ø—Ä–æ—Ñ–∏–ª—è -->
    <div class="profile-screen" id="profileScreen">
        <div class="profile-header">
            <button class="profile-back-button" id="profileBackButton">‚Üê</button>
            <div class="profile-avatar" id="profileAvatar">?</div>
            <div class="profile-name" id="profileName">–ò–º—è</div>
            <div class="profile-username" id="profileUsername">@username</div>
            <div class="profile-status">
                <span class="online-dot"></span>
                <span id="profileStatus">–æ–Ω–ª–∞–π–Ω</span>
            </div>
        </div>
        
        <div class="profile-content">
            <div class="profile-section">
                <div class="profile-section-title">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
                <div class="profile-info">
                    <div class="info-item">
                        <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                        <span class="info-value" id="profilePhone">+7 999 123 45 67</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Username:</span>
                        <span class="info-value viewable-field" id="profileUsernameInfo">@username</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–ò–º—è:</span>
                        <span class="info-value viewable-field" id="profileDisplayName">–ò–º—è</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:</span>
                        <span class="info-value" id="profileCreated">01.01.2024</span>
                    </div>
                </div>
            </div>
            
            <div class="profile-section">
                <div class="profile-section-title">‚úèÔ∏è –û —Å–µ–±–µ</div>
                <div class="profile-bio">
                    <textarea 
                        id="profileBio" 
                        placeholder="–†–∞—Å—Å–∫–∞–∂–∏—Ç–µ –æ —Å–µ–±–µ..."
                        maxlength="500"
                    ></textarea>
                    <div class="char-count">
                        <span id="bioCharCount">0</span>/500 —Å–∏–º–≤–æ–ª–æ–≤
                    </div>
                </div>
            </div>
        </div>
        
        <div class="profile-actions">
            <button class="profile-button" id="profileSaveButton" style="display: none;">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è</button>
            <button class="profile-button" id="profileMessageButton" style="display: none;">–ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button>
        </div>
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∞–≤–∞—Ç–∞—Ä–∫–∏ -->
    <div class="avatar-dialog" id="avatarDialog">
        <div class="avatar-container">
            <div class="edit-title">–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É</div>
            <div class="avatar-preview" id="avatarPreview">A</div>
            <div class="avatar-options" id="avatarOptions">
                <!-- –í–∞—Ä–∏–∞–Ω—Ç—ã –∞–≤–∞—Ç–∞—Ä–æ–∫ –±—É–¥—É—Ç –¥–æ–±–∞–≤–ª–µ–Ω—ã –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
            </div>
            <div class="edit-buttons">
                <button class="edit-button cancel" id="avatarCancelButton">–û—Ç–º–µ–Ω–∞</button>
                <button class="edit-button save" id="avatarSaveButton">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏ -->
    <div class="edit-dialog" id="editNameDialog">
        <div class="edit-container">
            <div class="edit-title">–ò–∑–º–µ–Ω–∏—Ç—å –∏–º—è</div>
            <input type="text" class="edit-input" id="editNameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –∏–º—è">
            <div class="edit-error" id="editNameError"></div>
            <div class="edit-buttons">
                <button class="edit-button cancel" id="editNameCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="edit-button save" id="editNameSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è username -->
    <div class="edit-dialog" id="editUsernameDialog">
        <div class="edit-container">
            <div class="edit-title">–ò–∑–º–µ–Ω–∏—Ç—å username</div>
            <input type="text" class="edit-input" id="editUsernameInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π username">
            <div class="edit-error" id="editUsernameError"></div>
            <div class="edit-time-left" id="editUsernameTimeLeft"></div>
            <div class="edit-buttons">
                <button class="edit-button cancel" id="editUsernameCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="edit-button save" id="editUsernameSave">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —á–∞—Ç–∞ -->
    <div class="confirm-chat-dialog" id="confirmChatDialog">
        <div class="confirm-chat-container">
            <div class="confirm-chat-icon">‚ùå</div>
            <div class="confirm-chat-title">–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç?</div>
            <div class="confirm-chat-text">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–∫—Ä—ã—Ç—å —ç—Ç–æ—Ç —á–∞—Ç? 
                –ò—Å—Ç–æ—Ä–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è, –∏ –≤—ã —Å–º–æ–∂–µ—Ç–µ —Å–Ω–æ–≤–∞ –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ –∏–∑ —Å–ø–∏—Å–∫–∞ —á–∞—Ç–æ–≤.
            </div>
            <div class="confirm-chat-buttons">
                <button class="confirm-chat-button cancel" id="confirmChatCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-chat-button leave" id="confirmChatLeave">–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç</button>
            </div>
        </div>
    </div>
    
    <!-- –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ -->
    <div class="confirm-dialog" id="confirmDialog">
        <div class="confirm-container">
            <div class="confirm-icon">üö™</div>
            <div class="confirm-title">–í—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞?</div>
            <div class="confirm-text">
                –í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –≤—ã–π—Ç–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞? 
                –í—ã —Å–º–æ–∂–µ—Ç–µ –≤–æ–π—Ç–∏ —Å–Ω–æ–≤–∞, –∏—Å–ø–æ–ª—å–∑—É—è –≤–∞—à —Ç–µ–ª–µ—Ñ–æ–Ω –∏ –ø–∞—Ä–æ–ª—å.
            </div>
            <div class="confirm-buttons">
                <button class="confirm-button cancel" id="confirmCancel">–û—Ç–º–µ–Ω–∞</button>
                <button class="confirm-button logout" id="confirmLogout">–í—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let accountsDB = {};
        let currentUser = null;
        let socket = null;
        let currentChat = null;
        let chats = [];
        let searchResultsCache = {};
        let currentProfileUser = null;
        let isMyProfile = false;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const authScreen = document.getElementById('authScreen');
        const loginScreen = document.getElementById('loginScreen');
        const registerScreen = document.getElementById('registerScreen');
        const appContainer = document.getElementById('appContainer');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const menuToggle = document.getElementById('menuToggle');
        const chatMenuButton = document.getElementById('chatMenuButton');
        const sidebarSearch = document.getElementById('sidebarSearch');
        const sidebarChats = document.getElementById('sidebarChats');
        const profileMenuItem = document.getElementById('profileMenuItem');
        const logoutMenuItem = document.getElementById('logoutMenuItem');
        const chatBackButton = document.getElementById('chatBackButton');
        const chatAvatar = document.getElementById('chatAvatar');
        const chatTitle = document.getElementById('chatTitle');
        const chatStatus = document.getElementById('chatStatus');
        const chatHeaderRight = document.getElementById('chatHeaderRight');
        const messagesContainer = document.getElementById('messagesContainer');
        const inputContainer = document.getElementById('inputContainer');
        const messageInput = document.getElementById('messageInput');
        const sendButton = document.getElementById('sendButton');
        const profileScreen = document.getElementById('profileScreen');
        const profileBackButton = document.getElementById('profileBackButton');
        const profileSaveButton = document.getElementById('profileSaveButton');
        const profileMessageButton = document.getElementById('profileMessageButton');
        const avatarDialog = document.getElementById('avatarDialog');
        const editNameDialog = document.getElementById('editNameDialog');
        const editUsernameDialog = document.getElementById('editUsernameDialog');
        const confirmChatDialog = document.getElementById('confirmChatDialog');
        const confirmChatCancel = document.getElementById('confirmChatCancel');
        const confirmChatLeave = document.getElementById('confirmChatLeave');
        const confirmDialog = document.getElementById('confirmDialog');
        const confirmCancel = document.getElementById('confirmCancel');
        const confirmLogout = document.getElementById('confirmLogout');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            loadAccounts();
            checkAutoLogin();
            setupEventListeners();
            createDemoAccounts();
            setupAvatarOptions();
        }
        
        function loadAccounts() {
            const saved = localStorage.getItem('chatAccounts');
            if (saved) {
                try {
                    accountsDB = JSON.parse(saved);
                } catch(e) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', e);
                    accountsDB = {};
                }
            }
        }
        
        function saveAccounts() {
            try {
                localStorage.setItem('chatAccounts', JSON.stringify(accountsDB));
                localStorage.setItem('lastUser', currentUser?.phone || '');
            } catch(e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∞–∫–∫–∞—É–Ω—Ç–æ–≤:', e);
            }
        }
        
        function checkAutoLogin() {
            const lastUser = localStorage.getItem('lastUser');
            if (lastUser && accountsDB[lastUser]) {
                autoLogin(lastUser);
            }
        }
        
        function autoLogin(userId) {
            const user = accountsDB[userId];
            if (user) {
                currentUser = {
                    phone: user.phone,
                    username: user.username,
                    displayName: user.displayName,
                    avatar: user.avatar || user.displayName.charAt(0).toUpperCase(),
                    bio: user.bio || '',
                    birthday: user.birthday || null,
                    createdAt: user.createdAt || new Date().toISOString(),
                    lastUsernameChange: user.lastUsernameChange || null
                };
                
                authScreen.classList.add('hidden');
                appContainer.classList.remove('hidden');
                connectToServer();
                
                showNotification('–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω');
            }
        }
        
        function setupEventListeners() {
            // –ö–Ω–æ–ø–∫–∏ –≥–ª–∞–≤–Ω–æ–≥–æ —ç–∫—Ä–∞–Ω–∞
            document.getElementById('loginButton').addEventListener('click', () => showScreen('login'));
            document.getElementById('registerButton').addEventListener('click', () => showScreen('register'));
            
            // –ö–Ω–æ–ø–∫–∏ –Ω–∞–∑–∞–¥
            document.getElementById('loginBackButton').addEventListener('click', () => showScreen('auth'));
            document.getElementById('registerBackButton').addEventListener('click', () => showScreen('auth'));
            
            // –í—Ö–æ–¥
            document.getElementById('loginSubmitButton').addEventListener('click', handleLogin);
            document.getElementById('loginPassword').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleLogin();
            });
            
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            document.getElementById('registerSubmitButton').addEventListener('click', handleRegister);
            document.getElementById('registerDisplayName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleRegister();
            });
            
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ username
            document.getElementById('registerUsername').addEventListener('input', checkUsernameAvailability);
            
            // –ú–ï–ù–Æ
            chatMenuButton.addEventListener('click', function() {
                sidebar.classList.add('show');
                overlay.classList.add('show');
            });
            
            menuToggle.addEventListener('click', function() {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            });
            
            overlay.addEventListener('click', function() {
                sidebar.classList.remove('show');
                overlay.classList.remove('show');
            });
            
            chatBackButton.addEventListener('click', function() {
                sidebar.classList.add('show');
                overlay.classList.add('show');
            });
            
            // –ü–æ–∏—Å–∫ –≤ –º–µ–Ω—é - –ò–°–ü–†–ê–í–õ–ï–ù–û
            sidebarSearch.addEventListener('input', debounce(function() {
                const query = this.value;
                const trimmedQuery = query ? query.trim() : '';
                searchUsers(trimmedQuery);
            }, 300));
            
            // –ú–µ–Ω—é –≤ –±–æ–∫–æ–≤–æ–π –ø–∞–Ω–µ–ª–∏ - –£–î–ê–õ–ï–ù –ù–û–í–´–ô –ß–ê–¢
            profileMenuItem.addEventListener('click', openMyProfile);
            logoutMenuItem.addEventListener('click', showLogoutDialog);
            
            // –ß–∞—Ç
            sendButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // –ê–≤—Ç–æ—Ä–∞–∑–º–µ—Ä –ø–æ–ª—è –≤–≤–æ–¥–∞
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
            });
            
            // –ü—Ä–æ—Ñ–∏–ª—å
            profileBackButton.addEventListener('click', closeProfile);
            profileSaveButton.addEventListener('click', saveProfile);
            profileMessageButton.addEventListener('click', sendMessageToProfileUser);
            document.getElementById('profileBio').addEventListener('input', function() {
                const count = this.value.length;
                document.getElementById('bioCharCount').textContent = count;
            });
            
            // –ê–≤–∞—Ç–∞—Ä–∫–∞ –≤ –ø—Ä–æ—Ñ–∏–ª–µ
            document.getElementById('profileAvatar').addEventListener('click', function() {
                if (isMyProfile) {
                    openAvatarDialog('profile');
                } else {
                    // –ü—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏ –¥—Ä—É–≥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    showNotification('–ü—Ä–æ—Å–º–æ—Ç—Ä –∞–≤–∞—Ç–∞—Ä–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
                }
            });
            
            // –ò–º—è –≤ –ø—Ä–æ—Ñ–∏–ª–µ
            document.getElementById('profileDisplayName').addEventListener('click', function() {
                if (isMyProfile) {
                    openEditNameDialog();
                }
            });
            
            // Username –≤ –ø—Ä–æ—Ñ–∏–ª–µ
            document.getElementById('profileUsernameInfo').addEventListener('click', function() {
                if (isMyProfile) {
                    openEditUsernameDialog();
                }
            });
            
            // –ê–≤–∞—Ç–∞—Ä–∫–∞ –≤ —á–∞—Ç–µ - –ò–°–ü–†–ê–í–õ–ï–ù –û–ë–†–ê–ë–û–¢–ß–ò–ö
            chatAvatar.addEventListener('click', function() {
                if (currentChat) {
                    openUserProfile(currentChat.username);
                }
            });
            
            // –ò–º—è –≤ —á–∞—Ç–µ - –ò–°–ü–†–ê–í–õ–ï–ù –û–ë–†–ê–ë–û–¢–ß–ò–ö
            chatTitle.addEventListener('click', function() {
                if (currentChat) {
                    openUserProfile(currentChat.username);
                }
            });
            
            // –î–∏–∞–ª–æ–≥ –∞–≤–∞—Ç–∞—Ä–∫–∏
            document.getElementById('avatarCancelButton').addEventListener('click', closeAvatarDialog);
            document.getElementById('avatarSaveButton').addEventListener('click', saveAvatar);
            avatarDialog.addEventListener('click', function(e) {
                if (e.target === avatarDialog) {
                    closeAvatarDialog();
                }
            });
            
            // –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–º–µ–Ω–∏
            document.getElementById('editNameCancel').addEventListener('click', closeEditNameDialog);
            document.getElementById('editNameSave').addEventListener('click', saveDisplayName);
            editNameDialog.addEventListener('click', function(e) {
                if (e.target === editNameDialog) {
                    closeEditNameDialog();
                }
            });
            
            // –î–∏–∞–ª–æ–≥ –∏–∑–º–µ–Ω–µ–Ω–∏—è username
            document.getElementById('editUsernameCancel').addEventListener('click', closeEditUsernameDialog);
            document.getElementById('editUsernameSave').addEventListener('click', saveUsername);
            editUsernameDialog.addEventListener('click', function(e) {
                if (e.target === editUsernameDialog) {
                    closeEditUsernameDialog();
                }
            });
            
            // –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ —á–∞—Ç–∞
            confirmChatCancel.addEventListener('click', hideChatLeaveDialog);
            confirmChatLeave.addEventListener('click', closeCurrentChat);
            confirmChatDialog.addEventListener('click', function(e) {
                if (e.target === confirmChatDialog) {
                    hideChatLeaveDialog();
                }
            });
            
            // –î–∏–∞–ª–æ–≥ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –≤—ã—Ö–æ–¥–∞ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞
            confirmCancel.addEventListener('click', hideLogoutDialog);
            confirmLogout.addEventListener('click', handleLogout);
            confirmDialog.addEventListener('click', function(e) {
                if (e.target === confirmDialog) {
                    hideLogoutDialog();
                }
            });
        }
        
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }
        
        function setupAvatarOptions() {
            const avatarOptions = document.getElementById('avatarOptions');
            const emojis = ['üòÄ', 'üòé', 'ü§ñ', 'üëª', 'üê±', 'üê∂', 'ü¶ä', 'üêº', 'üêØ', 'ü¶Å', 'üêÆ', 'üê∑', 'üê∏', 'üêµ'];
            const letters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
            
            let html = '';
            
            // –î–æ–±–∞–≤–ª—è–µ–º —ç–º–æ–¥–∑–∏
            emojis.forEach(emoji => {
                html += `<div class="avatar-option" data-avatar="${emoji}">${emoji}</div>`;
            });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –±—É–∫–≤—ã
            for (let i = 0; i < letters.length; i++) {
                html += `<div class="avatar-option" data-avatar="${letters[i]}">${letters[i]}</div>`;
            }
            
            avatarOptions.innerHTML = html;
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –≤—ã–±–æ—Ä–∞ –∞–≤–∞—Ç–∞—Ä–∫–∏
            avatarOptions.querySelectorAll('.avatar-option').forEach(option => {
                option.addEventListener('click', function() {
                    // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
                    avatarOptions.querySelectorAll('.avatar-option').forEach(opt => {
                        opt.classList.remove('selected');
                    });
                    
                    // –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é
                    this.classList.add('selected');
                    
                    // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–≤—å—é
                    const selectedAvatar = this.dataset.avatar;
                    document.getElementById('avatarPreview').textContent = selectedAvatar;
                });
            });
        }
        
        function showScreen(screenName) {
            authScreen.classList.add('hidden');
            loginScreen.classList.add('hidden');
            registerScreen.classList.add('hidden');
            appContainer.classList.add('hidden');
            profileScreen.classList.remove('show');
            
            switch(screenName) {
                case 'auth':
                    authScreen.classList.remove('hidden');
                    break;
                case 'login':
                    loginScreen.classList.remove('hidden');
                    document.getElementById('loginPhone').focus();
                    break;
                case 'register':
                    registerScreen.classList.remove('hidden');
                    document.getElementById('registerPhone').focus();
                    break;
                case 'app':
                    appContainer.classList.remove('hidden');
                    break;
            }
        }
        
        function checkUsernameAvailability() {
            const usernameInput = document.getElementById('registerUsername');
            const username = usernameInput.value.trim();
            const errorElement = document.getElementById('registerUsernameError');
            
            if (!username) {
                errorElement.textContent = '–í–≤–µ–¥–∏—Ç–µ username';
                errorElement.style.display = 'block';
                return false;
            }
            
            if (username.length < 3) {
                errorElement.textContent = 'Username –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorElement.style.display = 'block';
                return false;
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                errorElement.textContent = '–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ';
                errorElement.style.display = 'block';
                return false;
            }
            
            for (let phone in accountsDB) {
                if (accountsDB[phone].username === username) {
                    errorElement.textContent = '–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç';
                    errorElement.style.display = 'block';
                    return false;
                }
            }
            
            errorElement.style.display = 'none';
            return true;
        }
        
        function handleLogin() {
            const phoneOrUsername = document.getElementById('loginPhone').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            document.getElementById('loginPhoneError').style.display = 'none';
            document.getElementById('loginPasswordError').style.display = 'none';
            
            if (!phoneOrUsername) {
                document.getElementById('loginPhoneError').textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∏–ª–∏ username';
                document.getElementById('loginPhoneError').style.display = 'block';
                return;
            }
            
            if (!password) {
                document.getElementById('loginPasswordError').textContent = '–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å';
                document.getElementById('loginPasswordError').style.display = 'block';
                return;
            }
            
            let userFound = null;
            let userId = null;
            
            for (let phone in accountsDB) {
                const user = accountsDB[phone];
                if ((user.phone === phoneOrUsername || user.username === phoneOrUsername) && 
                    user.password === password) {
                    userFound = user;
                    userId = phone;
                    break;
                }
            }
            
            if (!userFound) {
                document.getElementById('loginPhoneError').textContent = '–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                document.getElementById('loginPhoneError').style.display = 'block';
                return;
            }
            
            currentUser = {
                phone: userFound.phone,
                username: userFound.username,
                displayName: userFound.displayName,
                avatar: userFound.avatar || userFound.displayName.charAt(0).toUpperCase(),
                bio: userFound.bio || '',
                birthday: userFound.birthday || null,
                createdAt: userFound.createdAt || new Date().toISOString(),
                lastUsernameChange: userFound.lastUsernameChange || null
            };
            
            saveAccounts();
            showScreen('app');
            connectToServer();
            
            showNotification('–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + currentUser.displayName + '!');
        }
        
        function handleRegister() {
            const phone = document.getElementById('registerPhone').value.trim();
            const username = document.getElementById('registerUsername').value.trim();
            const password = document.getElementById('registerPassword').value;
            const displayName = document.getElementById('registerDisplayName').value.trim();
            
            document.getElementById('registerPhoneError').style.display = 'none';
            document.getElementById('registerUsernameError').style.display = 'none';
            document.getElementById('registerPasswordError').style.display = 'none';
            document.getElementById('registerDisplayNameError').style.display = 'none';
            
            if (!phone) {
                document.getElementById('registerPhoneError').textContent = '–í–≤–µ–¥–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω';
                document.getElementById('registerPhoneError').style.display = 'block';
                return;
            }
            
            if (accountsDB[phone]) {
                document.getElementById('registerPhoneError').textContent = '–≠—Ç–æ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω —É–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω';
                document.getElementById('registerPhoneError').style.display = 'block';
                return;
            }
            
            if (!checkUsernameAvailability()) {
                return;
            }
            
            if (!password || password.length < 6) {
                document.getElementById('registerPasswordError').textContent = '–ü–∞—Ä–æ–ª—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤';
                document.getElementById('registerPasswordError').style.display = 'block';
                return;
            }
            
            if (!displayName) {
                document.getElementById('registerDisplayNameError').textContent = '–í–≤–µ–¥–∏—Ç–µ –≤–∞—à–µ –∏–º—è';
                document.getElementById('registerDisplayNameError').style.display = 'block';
                return;
            }
            
            accountsDB[phone] = {
                phone: phone,
                username: username,
                password: password,
                displayName: displayName,
                avatar: displayName.charAt(0).toUpperCase(),
                bio: '',
                birthday: null,
                createdAt: new Date().toISOString(),
                lastUsernameChange: null
            };
            
            saveAccounts();
            
            currentUser = {
                phone: phone,
                username: username,
                displayName: displayName,
                avatar: displayName.charAt(0).toUpperCase(),
                bio: '',
                birthday: null,
                createdAt: new Date().toISOString(),
                lastUsernameChange: null
            };
            
            showScreen('app');
            connectToServer();
            
            showNotification('–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + displayName + '!');
        }
        
        function connectToServer() {
            const serverUrl = 'ws://localhost:8080';
            
            try {
                socket = new WebSocket(serverUrl);
                
                socket.onopen = function() {
                    console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É');
                    
                    // –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                    socket.send(JSON.stringify({
                        type: 'register',
                        user: currentUser
                    }));
                    
                    // –ó–∞–ø—Ä–∞—à–∏–≤–∞–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
                    getChatsList();
                };
                
                socket.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        handleServerMessage(data);
                    } catch(e) {
                        console.error('–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞:', e);
                        showNotification('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                    }
                };
                
                socket.onclose = function() {
                    console.log('‚ùå –û—Ç–∫–ª—é—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                    if (currentUser) {
                        showNotification('–ü–æ—Ç–µ—Ä—è–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ. –ü–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...');
                        setTimeout(() => {
                            connectToServer();
                        }, 3000);
                    }
                };
                
                socket.onerror = function(error) {
                    console.error('WebSocket –æ—à–∏–±–∫–∞:', error);
                    showNotification('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
                };
                
            } catch(error) {
                console.error('–û—à–∏–±–∫–∞ WebSocket:', error);
                showNotification('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
            }
        }
        
        function handleServerMessage(data) {
            console.log('–ü–æ–ª—É—á–µ–Ω–æ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', data.type);
            
            switch(data.type) {
                case 'system':
                    showNotification(data.message);
                    if (data.user) {
                        currentUser = { ...currentUser, ...data.user };
                    }
                    break;
                    
                case 'search_results':
                    displaySearchResultsInSidebar(data.users);
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ –≤ –∫—ç—à
                    if (data.query) {
                        data.users.forEach(user => {
                            searchResultsCache[user.username] = user;
                        });
                    }
                    break;
                    
                case 'private_message':
                    handlePrivateMessage(data.message);
                    break;
                    
                case 'chats_list':
                    displayChatsList(data.chats);
                    break;
                    
                case 'chat_history':
                    displayChatHistory(data.messages, data.partner, data.partner_name, data.partner_avatar);
                    break;
                    
                case 'user_online':
                    updateUserStatus(data.user, true);
                    break;
                    
                case 'user_offline':
                    updateUserStatus(data.user, false);
                    break;
                    
                case 'user_profile':
                    if (data.profile) {
                        displayUserProfile(data.profile);
                    }
                    break;
                    
                case 'profile_updated':
                    if (data.profile) {
                        showNotification(data.message || '–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω');
                        updateCurrentUser(data.profile);
                        if (profileScreen.classList.contains('show') && isMyProfile) {
                            displayUserProfile(data.profile);
                        }
                    }
                    break;
                    
                case 'user_profile_updated':
                    // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
                    updateUserProfileInUI(data.user);
                    break;
                    
                case 'error':
                    showNotification(data.message);
                    break;
            }
        }
        
        function handlePrivateMessage(message) {
            // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π –æ—Ç–∫—Ä—ã—Ç—ã–π —á–∞—Ç, –¥–æ–±–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            if (currentChat && 
                (message.sender_username === currentChat.username ||
                 message.receiver_username === currentChat.username)) {
                
                addMessageToUI(message, false);
                
                // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
                setTimeout(() => {
                    messagesContainer.scrollTop = messagesContainer.scrollHeight;
                }, 100);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —á–∞—Ç–æ–≤
            getChatsList();
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –µ—Å–ª–∏ —á–∞—Ç –Ω–µ –æ—Ç–∫—Ä—ã—Ç
            if (!currentChat || currentChat.username !== message.sender_username) {
                showNotification(`–ù–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç ${message.sender_name || message.sender_username}`);
            }
        }
        
        function addMessageToUI(message, isTemp = false) {
            const emptyChat = messagesContainer.querySelector('.empty-chat');
            if (emptyChat) {
                emptyChat.remove();
            }
            
            const isMyMessage = message.sender_username === currentUser.username;
            const messageElement = document.createElement('div');
            messageElement.className = `message ${isMyMessage ? 'sent' : 'received'} ${isTemp ? 'temp' : ''}`;
            
            const time = new Date(message.timestamp * 1000).toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit'
            });
            
            messageElement.innerHTML = `
                <div class="message-bubble">
                    ${escapeHtml(message.text).replace(/\n/g, '<br>')}
                </div>
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageElement);
            
            // –ï—Å–ª–∏ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, —É–¥–∞–ª—è–µ–º –µ–≥–æ –ø–æ–∑–∂–µ
            if (isTemp) {
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.remove();
                    }
                }, 5000);
            }
        }
        
        function sendMessage() {
            const text = messageInput.value.trim();
            
            if (!text) {
                messageInput.focus();
                return;
            }
            
            if (!socket || socket.readyState !== WebSocket.OPEN) {
                showNotification('–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —Å–µ—Ä–≤–µ—Ä—É');
                return;
            }
            
            if (!currentChat) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
            const tempMessage = {
                id: Date.now(),
                sender_username: currentUser.username,
                sender_name: currentUser.displayName,
                text: text,
                timestamp: Date.now() / 1000,
                time: new Date().toLocaleTimeString('ru-RU', {
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                is_mine: true
            };
            
            addMessageToUI(tempMessage, true);
            
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            socket.send(JSON.stringify({
                type: 'private_message',
                text: text,
                receiver: currentChat.username
            }));
            
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.focus();
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        function showNotification(text) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = text;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        function getChatsList() {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'get_chats'
                }));
            }
        }
        
        function displayChatsList(chatList) {
            chats = chatList || [];
            sidebarChats.innerHTML = '';
            
            if (chats.length === 0) {
                sidebarChats.innerHTML = `
                    <div class="empty-chat">
                        <div class="empty-chat-icon">üí¨</div>
                        <h3 class="empty-chat-title">–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                        <p class="empty-chat-text">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                    </div>
                `;
                return;
            }
            
            chatList.forEach(chat => {
                const chatItem = document.createElement('div');
                chatItem.className = `menu-chat-item ${currentChat && currentChat.username === chat.username ? 'active' : ''}`;
                chatItem.dataset.username = chat.username;
                
                let timeText = '';
                if (chat.last_time) {
                    try {
                        const lastTime = new Date(chat.last_time);
                        const now = new Date();
                        const diffDays = Math.floor((now - lastTime) / (1000 * 60 * 60 * 24));
                        
                        if (diffDays === 0) {
                            timeText = lastTime.toLocaleTimeString('ru-RU', {
                                hour: '2-digit',
                                minute: '2-digit'
                            });
                        } else if (diffDays === 1) {
                            timeText = '–í—á–µ—Ä–∞';
                        } else if (diffDays < 7) {
                            const days = ['–≤—Å', '–ø–Ω', '–≤—Ç', '—Å—Ä', '—á—Ç', '–ø—Ç', '—Å–±'];
                            timeText = days[lastTime.getDay()];
                        } else {
                            timeText = lastTime.toLocaleDateString('ru-RU', {
                                day: '2-digit',
                                month: '2-digit'
                            });
                        }
                    } catch(e) {
                        timeText = '';
                    }
                }
                
                let lastMessage = chat.last_message || '–ù–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–π';
                if (lastMessage.length > 30) {
                    lastMessage = lastMessage.substring(0, 30) + '...';
                }
                
                let unreadBadge = '';
                if (chat.unread_count > 0) {
                    unreadBadge = `<span class="unread-badge">${chat.unread_count}</span>`;
                }
                
                chatItem.innerHTML = `
                    <div class="menu-chat-avatar" data-username="${chat.username}">${chat.avatar || chat.display_name.charAt(0)}</div>
                    <div class="menu-chat-info">
                        <div class="menu-chat-name" data-username="${chat.username}">${chat.display_name} ${unreadBadge}</div>
                        <div class="menu-chat-last">${lastMessage}</div>
                        <div class="menu-chat-time">${timeText}</div>
                    </div>
                `;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏ –≤ —á–∞—Ç–µ - –ò–°–ü–†–ê–í–õ–ï–ù
                const avatar = chatItem.querySelector('.menu-chat-avatar');
                avatar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    openUserProfile(chat.username);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–º–µ–Ω–∏ –≤ —á–∞—Ç–µ - –ò–°–ü–†–ê–í–õ–ï–ù
                const name = chatItem.querySelector('.menu-chat-name');
                name.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    openUserProfile(chat.username);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
                chatItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('menu-chat-avatar') && 
                        !e.target.classList.contains('menu-chat-name')) {
                        openChat(chat.username, chat.display_name, chat.avatar, chat.online);
                        sidebar.classList.remove('show');
                        overlay.classList.remove('show');
                    }
                });
                
                sidebarChats.appendChild(chatItem);
            });
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø –ü–û–ò–°–ö–ê
        function searchUsers(query) {
            // –ë–µ–∑–æ–ø–∞—Å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–ø—Ä–æ—Å–∞
            if (query === undefined || query === null) query = '';
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'search_users',
                    query: query
                }));
            } else {
                // –õ–æ–∫–∞–ª—å–Ω—ã–π –ø–æ–∏—Å–∫, –µ—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω
                const results = Object.values(accountsDB).filter(user => {
                    if (!user || user.username === currentUser.username) return false;
                    
                    if (!query || query === '') return true;
                    
                    const safeQuery = query.toLowerCase();
                    const usernameMatch = user.username && 
                                         user.username.toLowerCase().includes(safeQuery);
                    const nameMatch = user.displayName && 
                                     user.displayName.toLowerCase().includes(safeQuery);
                    
                    return usernameMatch || nameMatch;
                });
                
                displaySearchResultsInSidebar(results);
            }
        }
        
        function displaySearchResultsInSidebar(users) {
            sidebarChats.innerHTML = '';
            
            if (!users || users.length === 0) {
                sidebarChats.innerHTML = `
                    <div class="empty-chat">
                        <div class="empty-chat-icon">üòï</div>
                        <h3 class="empty-chat-title">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</h3>
                        <p class="empty-chat-text">–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –¥—Ä—É–≥–æ–π –∑–∞–ø—Ä–æ—Å</p>
                    </div>
                `;
                return;
            }
            
            users.forEach(user => {
                if (!user || !user.username) return;
                
                const chatItem = document.createElement('div');
                chatItem.className = 'menu-chat-item';
                chatItem.dataset.username = user.username;
                
                chatItem.innerHTML = `
                    <div class="menu-chat-avatar" data-username="${user.username}">${user.avatar || (user.displayName ? user.displayName.charAt(0) : '?')}</div>
                    <div class="menu-chat-info">
                        <div class="menu-chat-name" data-username="${user.username}">${user.displayName || user.username}</div>
                        <div class="menu-chat-last">@${user.username}</div>
                    </div>
                `;
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∞–≤–∞—Ç–∞—Ä–∫–∏ - –ò–°–ü–†–ê–í–õ–ï–ù
                const avatar = chatItem.querySelector('.menu-chat-avatar');
                avatar.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    openUserProfile(user.username);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∏–º–µ–Ω–∏ - –ò–°–ü–†–ê–í–õ–ï–ù
                const name = chatItem.querySelector('.menu-chat-name');
                name.addEventListener('click', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    openUserProfile(user.username);
                });
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —á–∞—Ç–∞
                chatItem.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('menu-chat-avatar') && 
                        !e.target.classList.contains('menu-chat-name')) {
                        startNewChat(user.username);
                        sidebarSearch.value = '';
                        getChatsList();
                    }
                });
                
                sidebarChats.appendChild(chatItem);
            });
        }
        
        function openChat(username, displayName, avatar, online) {
            // –ù–∞—Ö–æ–¥–∏–º —á–∞—Ç –≤ —Å–ø–∏—Å–∫–µ –∏–ª–∏ —Å–æ–∑–¥–∞–µ–º –Ω–æ–≤—ã–π
            let chat = chats.find(c => c.username === username);
            
            if (!chat) {
                // –ï—Å–ª–∏ —á–∞—Ç–∞ –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ, —Å–æ–∑–¥–∞–µ–º –µ–≥–æ
                chat = {
                    username: username,
                    display_name: displayName || username,
                    avatar: avatar || username.charAt(0).toUpperCase(),
                    online: online || false,
                    last_message: '',
                    unread_count: 0
                };
                chats.unshift(chat);
                displayChatsList(chats);
            }
            
            currentChat = {
                username: chat.username,
                display_name: chat.display_name,
                avatar: chat.avatar,
                online: chat.online
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            chatAvatar.textContent = currentChat.avatar;
            chatTitle.textContent = currentChat.display_name;
            chatStatus.textContent = currentChat.online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ—Ñ–ª–∞–π–Ω';
            chatStatus.style.color = currentChat.online ? 'var(--online)' : 'var(--gray)';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            inputContainer.classList.add('show');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –ø–µ—Ä–µ–ø–∏—Å–∫–∏
            getChatHistory(username);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –≤ –º–µ–Ω—é
            updateActiveChatInMenu();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏ –≤ –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å —à–∞–ø–∫–∏
            updateChatHeaderButtons();
            
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            setTimeout(() => {
                messageInput.focus();
            }, 100);
        }
        
        function updateChatHeaderButtons() {
            // –û—á–∏—â–∞–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å —à–∞–ø–∫–∏
            chatHeaderRight.innerHTML = '';
            
            if (!currentChat) return;
            
            // –°–æ–∑–¥–∞–µ–º –∏–∫–æ–Ω–∫–∏ –¥–ª—è —á–∞—Ç–∞
            const actions = [
                {
                    icon: 'üìé',
                    title: '–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª',
                    action: () => showNotification('–û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–∞–π–ª–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')
                },
                {
                    icon: 'üìû',
                    title: '–ó–≤–æ–Ω–æ–∫',
                    action: () => showNotification('–ì–æ–ª–æ—Å–æ–≤—ã–µ –∑–≤–æ–Ω–∫–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')
                },
                {
                    icon: '‚ùå',
                    title: '–ó–∞–∫—Ä—ã—Ç—å —á–∞—Ç',
                    action: () => showChatLeaveDialog(),
                    className: 'chat-leave-button'
                }
            ];
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∏–∫–æ–Ω–∫–∏
            actions.forEach(action => {
                const button = document.createElement('button');
                button.className = action.className || 'chat-action-button';
                button.innerHTML = action.icon;
                button.title = action.title;
                button.addEventListener('click', action.action);
                chatHeaderRight.appendChild(button);
            });
        }
        
        function showChatLeaveDialog() {
            confirmChatDialog.classList.add('show');
        }
        
        function hideChatLeaveDialog() {
            confirmChatDialog.classList.remove('show');
        }
        
        function closeCurrentChat() {
            hideChatLeaveDialog();
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ç–µ–∫—É—â–∏–π —á–∞—Ç
            currentChat = null;
            
            // –û—á–∏—â–∞–µ–º –ø—Ä–∞–≤—É—é —á–∞—Å—Ç—å —à–∞–ø–∫–∏
            chatHeaderRight.innerHTML = '';
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞
            inputContainer.classList.remove('show');
            
            // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            chatAvatar.textContent = 'üí¨';
            chatTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
            chatStatus.textContent = '–≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
            chatStatus.style.color = 'var(--gray)';
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥–ª—É—à–∫—É
            messagesContainer.innerHTML = `
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h3 class="empty-chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p class="empty-chat-text">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                </div>
            `;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—ã–π —á–∞—Ç –≤ –º–µ–Ω—é
            updateActiveChatInMenu();
            
            showNotification('–ß–∞—Ç –∑–∞–∫—Ä—ã—Ç');
        }
        
        function getChatHistory(username) {
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'get_chat_history',
                    partner: username
                }));
            } else {
                // –ï—Å–ª–∏ —Å–µ—Ä–≤–µ—Ä –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–π —á–∞—Ç
                displayChatHistory([], username, currentChat.display_name, currentChat.avatar);
            }
        }
        
        function updateActiveChatInMenu() {
            const items = sidebarChats.querySelectorAll('.menu-chat-item');
            items.forEach(item => {
                if (currentChat && item.dataset.username === currentChat.username) {
                    item.classList.add('active');
                } else {
                    item.classList.remove('active');
                }
            });
        }
        
        function displayChatHistory(messages, partnerUsername, partnerName, partnerAvatar) {
            messagesContainer.innerHTML = '';
            
            if (!messages || messages.length === 0) {
                messagesContainer.innerHTML = `
                    <div class="empty-chat">
                        <div class="empty-chat-icon">üí≠</div>
                        <h3 class="empty-chat-title">–ù–∞—á–Ω–∏—Ç–µ –¥–∏–∞–ª–æ–≥</h3>
                        <p class="empty-chat-text">–ù–∞–ø–∏—à–∏—Ç–µ –ø–µ—Ä–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ</p>
                    </div>
                `;
                return;
            }
            
            messages.forEach(msg => {
                addMessageToUI(msg);
            });
            
            setTimeout(() => {
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }, 100);
        }
        
        function updateUserStatus(user, isOnline) {
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
            const chatIndex = chats.findIndex(c => c.username === user.username);
            if (chatIndex !== -1) {
                chats[chatIndex].online = isOnline;
                displayChatsList(chats);
            }
            
            // –ï—Å–ª–∏ —ç—Ç–æ —Ç–µ–∫—É—â–∏–π —á–∞—Ç, –æ–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å
            if (currentChat && currentChat.username === user.username) {
                currentChat.online = isOnline;
                chatStatus.textContent = isOnline ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ—Ñ–ª–∞–π–Ω';
                chatStatus.style.color = isOnline ? 'var(--online)' : 'var(--gray)';
            }
        }
        
        function startNewChat(username) {
            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –∫—ç—à–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –ø–æ–∏—Å–∫–∞
            if (searchResultsCache[username]) {
                const user = searchResultsCache[username];
                openChat(user.username, user.display_name, user.avatar, user.online || false);
                showNotification(`–ß–∞—Ç —Å @${username} —Å–æ–∑–¥–∞–Ω`);
                return;
            }
            
            // –ï—Å–ª–∏ –Ω–µ—Ç –≤ –∫—ç—à–µ, –∏—â–µ–º –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ
            let partner = null;
            for (let phone in accountsDB) {
                if (accountsDB[phone].username === username) {
                    partner = accountsDB[phone];
                    break;
                }
            }
            
            if (partner) {
                openChat(partner.username, partner.displayName, partner.avatar, false);
                showNotification(`–ß–∞—Ç —Å @${username} —Å–æ–∑–¥–∞–Ω`);
            } else {
                // –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ, —Å–æ–∑–¥–∞–µ–º —á–∞—Ç —Å –±–∞–∑–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                openChat(username, username, username.charAt(0).toUpperCase(), false);
                showNotification(`–ß–∞—Ç —Å @${username} —Å–æ–∑–¥–∞–Ω`);
            }
        }
        
        function openMyProfile() {
            if (!currentUser) return;
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'get_user_profile',
                    username: currentUser.username
                }));
            } else {
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                displayUserProfile({
                    uid: 'local',
                    username: currentUser.username,
                    display_name: currentUser.displayName,
                    phone: currentUser.phone,
                    avatar: currentUser.avatar,
                    bio: currentUser.bio || '',
                    created_at: currentUser.createdAt,
                    can_change_username: true,
                    online: true,
                    is_me: true
                });
            }
        }
        
        function openUserProfile(username) {
            if (!username || username === 'undefined') return;
            
            console.log('–û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:', username);
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'get_user_profile',
                    username: username
                }));
            } else {
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è
                const user = Object.values(accountsDB).find(u => u.username === username);
                if (user) {
                    displayUserProfile({
                        uid: 'local',
                        username: user.username,
                        display_name: user.displayName,
                        phone: user.phone,
                        avatar: user.avatar,
                        bio: user.bio || '',
                        created_at: user.createdAt,
                        can_change_username: false,
                        online: false,
                        is_me: user.username === currentUser.username
                    });
                } else {
                    showNotification('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
            }
        }
        
        function displayUserProfile(profile) {
            if (!profile) return;
            
            currentProfileUser = profile;
            isMyProfile = profile.is_me;
            
            document.getElementById('profileAvatar').textContent = profile.avatar;
            document.getElementById('profileName').textContent = profile.display_name;
            document.getElementById('profileUsername').textContent = '@' + profile.username;
            document.getElementById('profileUsernameInfo').textContent = '@' + profile.username;
            document.getElementById('profilePhone').textContent = profile.phone;
            document.getElementById('profileDisplayName').textContent = profile.display_name;
            
            const regDate = new Date(profile.created_at);
            document.getElementById('profileCreated').textContent = 
                regDate.toLocaleDateString('ru-RU');
            
            const bioTextarea = document.getElementById('profileBio');
            bioTextarea.value = profile.bio || '';
            document.getElementById('bioCharCount').textContent = bioTextarea.value.length;
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            document.getElementById('profileStatus').textContent = profile.online ? '–æ–Ω–ª–∞–π–Ω' : '–æ—Ñ—Ñ–ª–∞–π–Ω';
            
            // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–æ—Å—Ç–∏ –ø–æ–ª–µ–π
            const avatar = document.getElementById('profileAvatar');
            const name = document.getElementById('profileName');
            const usernameElem = document.getElementById('profileUsername');
            const usernameInfo = document.getElementById('profileUsernameInfo');
            const displayNameInfo = document.getElementById('profileDisplayName');
            
            if (isMyProfile) {
                avatar.classList.remove('viewable');
                avatar.classList.add('editable');
                name.classList.add('editable');
                usernameElem.classList.add('editable');
                usernameInfo.classList.add('editable');
                displayNameInfo.classList.remove('viewable-field');
                displayNameInfo.classList.add('editable-field');
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
                profileSaveButton.style.display = 'block';
                profileMessageButton.style.display = 'none';
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –º–æ–∂–Ω–æ –ª–∏ –º–µ–Ω—è—Ç—å username
                if (!profile.can_change_username && profile.time_left) {
                    usernameElem.classList.add('disabled');
                    usernameElem.title = `–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑: ${profile.time_left}`;
                    usernameInfo.classList.add('disabled');
                    usernameInfo.title = `–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —á–µ—Ä–µ–∑: ${profile.time_left}`;
                } else {
                    usernameElem.classList.remove('disabled');
                    usernameElem.title = '';
                    usernameInfo.classList.remove('disabled');
                    usernameInfo.title = '';
                }
            } else {
                avatar.classList.remove('editable');
                avatar.classList.add('viewable');
                name.classList.remove('editable');
                usernameElem.classList.remove('editable');
                usernameInfo.classList.remove('editable');
                displayNameInfo.classList.remove('editable-field');
                displayNameInfo.classList.add('viewable-field');
                
                // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–æ–∫
                profileSaveButton.style.display = 'none';
                profileMessageButton.style.display = 'block';
            }
            
            // –°–∫—Ä—ã–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –≤—Ä–µ–º—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø—Ä–æ—Ñ–∏–ª—è
            inputContainer.classList.remove('show');
            
            profileScreen.classList.add('show');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }
        
        function closeProfile() {
            profileScreen.classList.remove('show');
            currentProfileUser = null;
            isMyProfile = false;
            
            // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞, –µ—Å–ª–∏ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç —á–∞—Ç
            if (currentChat) {
                inputContainer.classList.add('show');
            }
        }
        
        function saveProfile() {
            const bio = document.getElementById('profileBio').value.trim();
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'update_profile',
                    bio: bio
                }));
            } else {
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
                if (accountsDB[currentUser.phone]) {
                    accountsDB[currentUser.phone].bio = bio;
                    saveAccounts();
                }
                
                closeProfile();
                showNotification('–ü—Ä–æ—Ñ–∏–ª—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω');
            }
        }
        
        function sendMessageToProfileUser() {
            if (!currentProfileUser) return;
            
            closeProfile();
            
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º —á–∞—Ç —Å —ç—Ç–∏–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
            startNewChat(currentProfileUser.username);
        }
        
        function updateCurrentUser(profile) {
            currentUser = {
                ...currentUser,
                username: profile.username,
                displayName: profile.display_name,
                avatar: profile.avatar,
                bio: profile.bio
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
            if (accountsDB[currentUser.phone]) {
                accountsDB[currentUser.phone].username = profile.username;
                accountsDB[currentUser.phone].displayName = profile.display_name;
                accountsDB[currentUser.phone].avatar = profile.avatar;
                accountsDB[currentUser.phone].bio = profile.bio;
                saveAccounts();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
            if (currentChat && currentChat.username === profile.username) {
                chatAvatar.textContent = profile.avatar;
                chatTitle.textContent = profile.display_name;
            }
        }
        
        function updateUserProfileInUI(user) {
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Ñ–∏–ª—å –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ, –µ—Å–ª–∏ –æ–Ω –æ—Ç–∫—Ä—ã—Ç
            if (currentProfileUser && currentProfileUser.uid === user.uid) {
                document.getElementById('profileAvatar').textContent = user.avatar;
                document.getElementById('profileName').textContent = user.display_name;
                document.getElementById('profileUsername').textContent = '@' + user.username;
                document.getElementById('profileUsernameInfo').textContent = '@' + user.username;
                document.getElementById('profileDisplayName').textContent = user.display_name;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–∫–µ —á–∞—Ç–æ–≤
            const chatIndex = chats.findIndex(c => c.username === user.username);
            if (chatIndex !== -1) {
                chats[chatIndex].avatar = user.avatar;
                chats[chatIndex].display_name = user.display_name;
                displayChatsList(chats);
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –≤ —Ç–µ–∫—É—â–µ–º —á–∞—Ç–µ
            if (currentChat && currentChat.username === user.username) {
                currentChat.avatar = user.avatar;
                currentChat.display_name = user.display_name;
                chatAvatar.textContent = user.avatar;
                chatTitle.textContent = user.display_name;
            }
        }
        
        function openAvatarDialog(context) {
            const currentAvatar = context === 'profile' 
                ? document.getElementById('profileAvatar').textContent
                : (currentUser?.avatar || 'A');
            
            document.getElementById('avatarPreview').textContent = currentAvatar;
            
            // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö –∞–≤–∞—Ç–∞—Ä–æ–∫
            document.querySelectorAll('.avatar-option').forEach(opt => {
                opt.classList.remove('selected');
                if (opt.dataset.avatar === currentAvatar) {
                    opt.classList.add('selected');
                }
            });
            
            avatarDialog.classList.add('show');
        }
        
        function closeAvatarDialog() {
            avatarDialog.classList.remove('show');
        }
        
        function saveAvatar() {
            const selectedAvatar = document.querySelector('.avatar-option.selected');
            if (!selectedAvatar) {
                showNotification('–í—ã–±–µ—Ä–∏—Ç–µ –∞–≤–∞—Ç–∞—Ä–∫—É');
                return;
            }
            
            const newAvatar = selectedAvatar.dataset.avatar;
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'update_profile',
                    avatar: newAvatar
                }));
            } else {
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (accountsDB[currentUser.phone]) {
                    accountsDB[currentUser.phone].avatar = newAvatar;
                    saveAccounts();
                }
                
                currentUser.avatar = newAvatar;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('profileAvatar').textContent = newAvatar;
                if (currentProfileUser && isMyProfile) {
                    currentProfileUser.avatar = newAvatar;
                }
                
                showNotification('–ê–≤–∞—Ç–∞—Ä–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞');
            }
            
            closeAvatarDialog();
        }
        
        function openEditNameDialog() {
            document.getElementById('editNameInput').value = currentUser.displayName;
            document.getElementById('editNameError').style.display = 'none';
            editNameDialog.classList.add('show');
        }
        
        function closeEditNameDialog() {
            editNameDialog.classList.remove('show');
        }
        
        function saveDisplayName() {
            const newName = document.getElementById('editNameInput').value.trim();
            const errorElement = document.getElementById('editNameError');
            
            if (!newName) {
                errorElement.textContent = '–í–≤–µ–¥–∏—Ç–µ –∏–º—è';
                errorElement.style.display = 'block';
                return;
            }
            
            if (newName.length < 2) {
                errorElement.textContent = '–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 2 —Å–∏–º–≤–æ–ª–∞';
                errorElement.style.display = 'block';
                return;
            }
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'update_profile',
                    display_name: newName
                }));
            } else {
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (accountsDB[currentUser.phone]) {
                    accountsDB[currentUser.phone].displayName = newName;
                    saveAccounts();
                }
                
                currentUser.displayName = newName;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('profileName').textContent = newName;
                document.getElementById('profileDisplayName').textContent = newName;
                if (currentProfileUser && isMyProfile) {
                    currentProfileUser.display_name = newName;
                }
                
                showNotification('–ò–º—è –æ–±–Ω–æ–≤–ª–µ–Ω–æ');
            }
            
            closeEditNameDialog();
        }
        
        function openEditUsernameDialog() {
            if (!currentProfileUser.can_change_username && currentProfileUser.time_left) {
                showNotification(`–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å username —Ç–æ–ª—å–∫–æ —Ä–∞–∑ –≤ 8 —á–∞—Å–æ–≤. –û—Å—Ç–∞–ª–æ—Å—å: ${currentProfileUser.time_left}`);
                return;
            }
            
            document.getElementById('editUsernameInput').value = currentUser.username;
            document.getElementById('editUsernameError').style.display = 'none';
            
            if (currentProfileUser.time_left) {
                document.getElementById('editUsernameTimeLeft').textContent = 
                    `–ú–æ–∂–Ω–æ –º–µ–Ω—è—Ç—å —Ä–∞–∑ –≤ 8 —á–∞—Å–æ–≤. –û—Å—Ç–∞–ª–æ—Å—å: ${currentProfileUser.time_left}`;
                document.getElementById('editUsernameTimeLeft').style.display = 'block';
            } else {
                document.getElementById('editUsernameTimeLeft').style.display = 'none';
            }
            
            editUsernameDialog.classList.add('show');
        }
        
        function closeEditUsernameDialog() {
            editUsernameDialog.classList.remove('show');
        }
        
        function saveUsername() {
            const newUsername = document.getElementById('editUsernameInput').value.trim();
            const errorElement = document.getElementById('editUsernameError');
            
            if (!newUsername) {
                errorElement.textContent = '–í–≤–µ–¥–∏—Ç–µ username';
                errorElement.style.display = 'block';
                return;
            }
            
            if (newUsername.length < 3) {
                errorElement.textContent = 'Username –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –º–∏–Ω–∏–º—É–º 3 —Å–∏–º–≤–æ–ª–∞';
                errorElement.style.display = 'block';
                return;
            }
            
            if (!/^[a-zA-Z0-9_]+$/.test(newUsername)) {
                errorElement.textContent = '–¢–æ–ª—å–∫–æ –ª–∞—Ç–∏–Ω—Å–∫–∏–µ –±—É–∫–≤—ã, —Ü–∏—Ñ—Ä—ã –∏ –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ';
                errorElement.style.display = 'block';
                return;
            }
            
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'update_profile',
                    username: newUsername
                }));
            } else {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç—å
                for (let phone in accountsDB) {
                    if (accountsDB[phone].username === newUsername && phone !== currentUser.phone) {
                        errorElement.textContent = '–≠—Ç–æ—Ç username —É–∂–µ –∑–∞–Ω—è—Ç';
                        errorElement.style.display = 'block';
                        return;
                    }
                }
                
                // –õ–æ–∫–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
                if (accountsDB[currentUser.phone]) {
                    accountsDB[currentUser.phone].username = newUsername;
                    accountsDB[currentUser.phone].lastUsernameChange = new Date().toISOString();
                    saveAccounts();
                }
                
                currentUser.username = newUsername;
                currentUser.lastUsernameChange = new Date().toISOString();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
                document.getElementById('profileUsername').textContent = '@' + newUsername;
                document.getElementById('profileUsernameInfo').textContent = '@' + newUsername;
                if (currentProfileUser && isMyProfile) {
                    currentProfileUser.username = newUsername;
                }
                
                showNotification('Username –æ–±–Ω–æ–≤–ª–µ–Ω');
            }
            
            closeEditUsernameDialog();
        }
        
        function showLogoutDialog() {
            confirmDialog.classList.add('show');
            sidebar.classList.remove('show');
            overlay.classList.remove('show');
        }
        
        function hideLogoutDialog() {
            confirmDialog.classList.remove('show');
        }
        
        function handleLogout() {
            hideLogoutDialog();
            
            if (socket) {
                socket.close();
                socket = null;
            }
            
            currentUser = null;
            currentChat = null;
            currentProfileUser = null;
            isMyProfile = false;
            chats = [];
            searchResultsCache = {};
            
            inputContainer.classList.remove('show');
            
            messagesContainer.innerHTML = `
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h3 class="empty-chat-title">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç</h3>
                    <p class="empty-chat-text">–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–π—Ç–µ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                </div>
            `;
            
            chatAvatar.textContent = 'üí¨';
            chatTitle.textContent = '–í—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
            chatStatus.textContent = '–≤—ã–±–µ—Ä–∏—Ç–µ —á–∞—Ç';
            
            sidebarChats.innerHTML = `
                <div class="empty-chat">
                    <div class="empty-chat-icon">üí¨</div>
                    <h3 class="empty-chat-title">–ù–µ—Ç —á–∞—Ç–æ–≤</h3>
                    <p class="empty-chat-text">–ù–∞—á–Ω–∏—Ç–µ –æ–±—â–µ–Ω–∏–µ —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ –ø–æ–∏—Å–∫</p>
                </div>
            `;
            
            localStorage.removeItem('lastUser');
            
            appContainer.classList.add('hidden');
            authScreen.classList.remove('hidden');
            
            showNotification('–í—ã –≤—ã—à–ª–∏ –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞');
        }
        
        function createDemoAccounts() {
            if (Object.keys(accountsDB).length === 0) {
                accountsDB['79991234567'] = {
                    phone: '79991234567',
                    username: 'alex',
                    password: '123456',
                    displayName: '–ê–ª–µ–∫—Å–µ–π',
                    avatar: 'üòé',
                    bio: '–õ—é–±–ª—é –ø—Ä–æ–≥—Ä–∞–º–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏ –∫–æ—Ñ–µ ‚òï',
                    birthday: '1995-05-15',
                    createdAt: '2024-01-15T10:30:00Z',
                    lastUsernameChange: null
                };
                
                accountsDB['79997654321'] = {
                    phone: '79997654321',
                    username: 'maria',
                    password: '123456',
                    displayName: '–ú–∞—Ä–∏—è',
                    avatar: 'üë©',
                    bio: '–î–∏–∑–∞–π–Ω–µ—Ä, —Ö—É–¥–æ–∂–Ω–∏–∫, –º–µ—á—Ç–∞—Ç–µ–ª—å ‚ú®',
                    birthday: '1998-08-22',
                    createdAt: '2024-01-18T14:20:00Z',
                    lastUsernameChange: null
                };
                
                accountsDB['79999876543'] = {
                    phone: '79999876543',
                    username: 'ivan',
                    password: '123456',
                    displayName: '–ò–≤–∞–Ω',
                    avatar: 'üë®',
                    bio: '–ì–µ–π–º–µ—Ä –∏ –∫–∏–±–µ—Ä—Å–ø–æ—Ä—Ç—Å–º–µ–Ω üéÆ',
                    birthday: '2000-03-10',
                    createdAt: '2024-01-20T09:15:00Z',
                    lastUsernameChange: null
                };
                
                saveAccounts();
            }
        }
        
        // –ó–∞–ø—É—Å–∫ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', init);
        
    </script>
</body>
</html>